# System Design социальной сети

## Функциональные требования

1. **Публикация постов**
   - Добавление фотографии к посту
   - Добавление геометки
   - Добавление текстового описания

2. **Оценки и комментарии**
   - Лайки постов
   - Возможность комментировать посты
   - Комментарии постов
     - Выдача комментариев с пагинацией
     - Видно имя пользователя в комментарии
     - Виден текст комментария
     - Без ветвления
     - Без сортировки комментариев
     - Без лайков комментариев
     - Без возможности отвечать на комментарии других пользователей
     - Без возможности вызывать пользователей в комментариях
     - Без аватара автора комментария

3. **Подписка на других пользователей**
   - Возможность отменить подписку

4. **Лента постов**
   - Выдача с пагинацией
   - Общая лента
     - Сортировка по дате добавления: по убыванию
   - Лента подписок
     - Сортировка по дате добавления: по убыванию

5. **Поиск постов**
   - Поиск по геометке
   - Поиск по строке
   - Выдача с пагинацией

---

## Нефункциональные требования

### Общее

1. **DAU**: 10 000 000  
2. **Регион**: страны СНГ  
3. **Сезонность**: 15.05 — 15.09, 15.12-15.01
4. **Коэффициент сезонности**: 1.2
5. **Данные храним всегда**  
6. **Доступность**: 99% (в идеале 95%, раз уж я представляю разработку)  

---

## Лимиты и ограничения

1. Количество отображаемых постов на странице во всех лентах: **10**
2. Количество отображаемых комментариев под постом на одной странице: **30**
3. Количество подписок у одного пользователя: **1000**
4. Максимальный размер загружаемой фотографии: **2MB**
5. Разрешенные форматы фотографий: **JPEG, PNG, WebP**
6. Разрешенные параметры изображения:
   - Отношение сторон не меньше **1/3**
   - Размер любой стороны: не больше **4000px** и не меньше **360px**
7. Максимальное количество изображений в посте: **5**
8. Максимальное количество символов в посте: **3000**
9. Максимальное количество подписчиков у одного пользователя: **100000**
10. Без ограничения количества постов или лайков в день, но лимит **RPS на запись на юзера = 1**
11. Максимальное количество символов в комментарии: **500**

---

## Оценка нагрузки

> За основу взята статистика Пикабу за октябрь 2024  
> https://pikabu.ru/story/pikabu_itogi_oktyabrya_2024_g_12048759  
> https://special.pikabu.ru/mediakit  

**DAU**: 3 000 000  
**Коэффициент отличия DAU** от нашего сервиса: **3.33**

Так как есть информация по среднему распределению публикации постов по часам, можно приблизительно узнать **средний RPS в прайм-тайм**:  
> https://pikabu.ru/story/logika_pikabu_ili_analiz_statistiki_postov_za_4_nedeli_4348954  

- Общее количество постов в сутки в графике: **17650**
- Максимальное количество постов в час: **1200**
- Максимальный RPS публикации постов исходя из графика: ~**7% от суточного RPS в час**
- Проставлено оценок постам: 29 674 710 плюсов и 2 927 198 минусов = 32601908

---

### RPS при равномерно распределенной нагрузке

| Действие               | Формула | RPS |
|------------------------|---------|-----|
| Создание постов        | `110656 * 3.33 / 30 / 86400` | **0.14** |
| Создание комментариев  | `3754681 * 3.33 / 30 / 86400` | **4.8** |
| Лайк                   | `32601908 * 3.33 / 30 / 86400` | **42** |
| Просмотр постов        | `2236649217 * 3.33 / 30 / 86400` | **2873.4** |

---

### RPS при реальной нагрузке (7% прайм-тайм)

| Действие               | Формула | RPS |
|------------------------|---------|-----|
| Создание постов        | `110656 * 3.33 / 30 * 0.07 / 3600` | **0.23** |
| Создание комментариев  | `3754681 * 3.33 / 30 * 0.07 / 3600` | **8.1** |
| Лайк                   | `32601908 * 3.33 / 30 * 0.07 / 3600` | **70** |
| Просмотр постов        | `2236649217 * 3.33 / 30 * 0.07 / 3600` | **4827** |

---

## Средний трафик

### Один пост:

- 3 изображения среднего качества = **2250 KB**
- 50% заполненный description = **1.5 KB**
- Метаинформация = **0.05 KB**  
**Итог**: **2 256 KB**

### Один комментарий:

- Текст (120 символов) ≈ **200 B**
- Метаинформация ≈ **50 B**  
**Итог**: **0.25 KB**

### Один комментарий*:
**Итог**: **0.8 KB**

> Источники:
> - Среднее качество фото: 500–1000 KB для JPEG  
>   https://www.quora.com/What-is-the-average-size-of-an-image  
> - Средняя длина комментария на DTF  
>   https://dtf.ru/flood/651236-analiz-kommentariev-za-nachalo-2021-klassovaya-borba
>   Проставлен лайк на pikabu и посчитан размер payload'a

---

### Допущение:

Чтение 1 комментария на 1 пост (10% пользователей переходят внутрь поста из ленты и видят первые 10 комментариев).

---

## Трафик

### При равномерной нагрузке:

| Действие               | Формула              | Трафик             | Нагрузка (Мбит/с)   |
|------------------------|----------------------|--------------------|---------------------|
| Создание постов        | `0.14 * 2256000`     | 315 840 байт/с     | **2.53 Мбит/с**     |
| Создание комментариев  | `4.8 * 200`          | 960 байт/с         | **0.008 Мбит/с**    |
| Лайк                   | `42 * 800`           | 33 600 байт/с      | **0.27 Мбит/с**     |
| Просмотр постов        | `2873.4 * 2256000`   | 6 482 390 400 байт/с | **51 859.12 Мбит/с** |
| Просмотр комментариев  | `2873.4 * 200`       | 574 680 байт/с     | **4.60 Мбит/с**     |

#### Итого

**Медиаданные:**  
- Чтение: **53 Гбит/с**  
- Запись: **2.58 Мбит/с**  

**Метаинформация:**  
- Чтение: **42.23 Мбит/с**  
- Запись: **0.28 Мбит/с**  

---

### При реальной нагрузке:

| Действие               | Формула              | Трафик             | Нагрузка (Мбит/с)   |
|------------------------|----------------------|--------------------|---------------------|
| Создание постов        | `0.23 * 2256000`     | 518 880 байт/с     | **4.15 Мбит/с**     |
| Создание комментариев  | `8.1 * 200`          | 1 620 байт/с       | **0.013 Мбит/с**    |
| Лайк                   | `70 * 800`           | 56 000 байт/с      | **0.45 Мбит/с**     |
| Просмотр постов        | `4827 * 2256000`     | 10 889 712 000 байт/с | **87 117.7 Мбит/с** |
| Просмотр комментариев  | `4827 * 200`         | 965 400 байт/с     | **7.72 Мбит/с**     |

#### Итого

**Медиаданные:**  
- Чтение: **10 860.75 Мбит/с**  
- Запись: **0.5175 Мбит/с**  

**Метаинформация:**  
- Чтение: **70.94 Мбит/с**  
- Запись: **0.47 Мбит/с**  
## Тайминги мс
#### **Публикация фото:**  
- Среднее время: **1500**  
- 95-й перцентиль: **3000**  
- 99-й перцентиль: **4000**
- 99.9-й перцентиль: **6000**

#### **Публикация поста:**  
- Среднее время: **1200**  
- 95-й перцентиль: **2500**  
- 99-й перцентиль: **3000**
- 99.9-й перцентиль: **6000**

#### **Публикация комментария:**  
- Среднее время: **1000**  
- 95-й перцентиль: **2000**  
- 99-й перцентиль: **3000**
- 99.9-й перцентиль: **5000**

#### **Проставление лайка:**  
- Среднее время: **1000**  
- 95-й перцентиль: **1800**  
- 99-й перцентиль: **2000**
- 99.9-й перцентиль: **4000**

#### **Загрузка ленты:**  
- Среднее время: **1200**  
- 95-й перцентиль: **2500**  
- 99-й перцентиль: **3000**
- 99.9-й перцентиль: **6000**

#### **Загрузка ленты подписок:**  
- Среднее время: **1300**  
- 95-й перцентиль: **2700**  
- 99-й перцентиль: **4000** 
- 99.9-й перцентиль: **6000**

#### **Загрузка комментариев:**  
- Среднее время: **1100**  
- 95-й перцентиль: **2200**  
- 99-й перцентиль: **3000**  
- 99.9-й перцентиль: **5000**

#### **Поиск по геолокации:**  
- Среднее время: **2000**  
- 95-й перцентиль: **4000**  
- 99-й перцентиль: **5000**
- 99.9-й перцентиль: **8000**

***Ресурсы***
IOPS = (0.23 + 8.1 + 70 + 4827) * 1.2 = 5886.3

capacity: ((2.96 мбит\c * 86400)/8) * 365 = 11.67 ТБ
Disks_for_capacity: 11.67/2 = 6
Disks_for_throughput: (11000/8)/500 = 3
Disks_for_iops: 5886.3 / 1000 = 6
