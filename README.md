# System Design социальной сети

## Функциональные требования

1. **Публикация постов**
   - Добавление фотографии к посту
   - Добавление геометки
   - Добавление текстового описания

2. **Оценки и комментарии**
   - Лайки постов
   - Возможность комментировать посты
   - Комментарии постов
     - Выдача комментариев с пагинацией
     - Видно имя пользователя в комментарии
     - Виден текст комментария
     - Без ветвления
     - Без сортировки комментариев
     - Без лайков комментариев
     - Без возможности отвечать на комментарии других пользователей
     - Без возможности вызывать пользователей в комментариях
     - Без аватара автора комментария

3. **Подписка на других пользователей**
   - Возможность отменить подписку

4. **Лента постов**
   - Выдача с пагинацией
   - Общая лента
     - Сортировка по дате добавления: по убыванию
   - Лента подписок
     - Сортировка по дате добавления: по убыванию

5. **Поиск постов**
   - Поиск по геометке
   - Поиск по строке
   - Выдача с пагинацией

---

## Нефункциональные требования

### Общее

1. **DAU**: 10 000 000  
2. **Регион**: страны СНГ  
3. **Сезонность**: середина мая — середина сентября, новогодние праздники  
4. **Данные храним всегда**  
5. **Доступность**: 99% (в идеале 95%, раз уж я представляю разработку)  

---

## Лимиты и ограничения

1. Количество отображаемых постов на странице во всех лентах: **10**
2. Количество отображаемых комментариев под постом на одной странице: **30**
3. Количество подписок у одного пользователя: **1000**
4. Максимальный размер загружаемой фотографии: **2MB**
5. Разрешенные форматы фотографий: **JPEG, PNG, WebP**
6. Разрешенные параметры изображения:
   - Отношение сторон не меньше **1/3**
   - Размер любой стороны: не больше **4000px** и не меньше **360px**
7. Максимальное количество изображений в посте: **5**
8. Максимальное количество символов в посте: **3000**
9. Максимальное количество подписчиков у одного пользователя: **100000**
10. Без ограничения количества постов или лайков в день, но лимит **RPS на запись на юзера = 1**
11. Максимальное количество символов в комментарии: **500**

---

## Оценка нагрузки

> За основу взята статистика Пикабу за октябрь 2024  
> https://pikabu.ru/story/pikabu_itogi_oktyabrya_2024_g_12048759  
> https://special.pikabu.ru/mediakit  

**DAU**: 3 000 000  
**Коэффициент отличия DAU** от нашего сервиса: **3.33**

Так как есть информация по среднему распределению публикации постов по часам, можно приблизительно узнать **средний RPS в прайм-тайм**:  
> https://pikabu.ru/story/logika_pikabu_ili_analiz_statistiki_postov_za_4_nedeli_4348954  

- Общее количество постов в сутки в графике: **17650**
- Максимальное количество постов в час: **1200**
- Максимальный RPS публикации постов исходя из графика: ~**7% от суточного RPS в час**

---

### RPS при равномерно распределенной нагрузке

| Действие               | Формула | RPS |
|------------------------|---------|-----|
| Создание постов        | `110656 * 3.33 / 30 / 86400` | **0.14** |
| Создание комментариев  | `3754681 * 3.33 / 30 / 86400` | **4.8** |
| Просмотр постов        | `2236649217 * 3.33 / 30 / 86400` | **2873.4** |

---

### RPS при реальной нагрузке (7% прайм-тайм)

| Действие               | Формула | RPS |
|------------------------|---------|-----|
| Создание постов        | `110656 * 3.33 / 30 * 0.07 / 3600` | **0.23** |
| Создание комментариев  | `3754681 * 3.33 / 30 * 0.07 / 3600` | **8.1** |
| Просмотр постов        | `2236649217 * 3.33 / 30 * 0.07 / 3600` | **4827** |

---

## Средний трафик

### Один пост:

- 3 изображения среднего качества = **2250 KB**
- 50% заполненный description = **1.5 KB**
- Метаинформация = **0.05 KB**  
**Итог**: **2 256 000 B**

### Один комментарий:

- Текст (120 символов) ≈ **200 B**
- Метаинформация ≈ **50 B**  
**Итог**: **250 B**

> Источники:
> - Среднее качество фото: 500–1000 KB для JPEG  
>   https://www.quora.com/What-is-the-average-size-of-an-image  
> - Средняя длина комментария на DTF  
>   https://dtf.ru/flood/651236-analiz-kommentariev-za-nachalo-2021-klassovaya-borba  

---

### Допущение:

Чтение 1 комментария на 1 пост (10% пользователей переходят внутрь поста из ленты и видят первые 10 комментариев).

---

## Трафик

### При равномерной нагрузке:

| Действие               | Формула | Трафик |
|------------------------|---------|--------|
| Создание постов        | `0.14 * 2256000` | **315 840 байт/с** |
| Создание комментариев  | `4.8 * 200` | **960 байт/с** |
| Просмотр постов        | `2873.4 * 2256000` | **6 482 390 400 байт/с** |
| Просмотр комментариев  | `2873.4 * 200` | **574 680 байт/с** |
| **Итого**              |          | **6 483 281 880 байт/с** = **6483.28 МБ/с** = **51 866.25 Мбит/с** |

---

### При реальной нагрузке:

| Действие               | Формула | Трафик |
|------------------------|---------|--------|
| Создание постов        | `0.23 * 2256000` | **518 880 байт/с** |
| Создание комментариев  | `8.1 * 200` | **1620 байт/с** |
| Просмотр постов        | `4827 * 2256000` | **10 889 712 000 байт/с** |
| Просмотр комментариев  | `2873.4 * 200` | **574 680 байт/с** |
| **Итого**              |          | **10 890 807 180 байт/с** = **10 890.81 МБ/с** = **87 126.46 Мбит/с** |
